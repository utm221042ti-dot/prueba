<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Productos</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css">
  <style>
    /*Miniaturas de imágenes dentro de las tarjetas*/
    .thumb { object-fit: cover; height: 100px; border-radius: .5rem;}
    .thumbs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap:0.5rem }
  </style>

  <!--Metadatos PWA -->
  <link rel="manifest" href="manifest.webmanifest"/>
  <meta name="theme-color" content="#7D0202"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    /* Botón de instalación visible y flotante */
    #btnInstall {
      position: fixed; right: 16px; bottom: 16px;
      padding: 12px 16px; border: 0; border-radius: 10px;
      background: peru; color: white; font-size: 14px; cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.2); z-index: 9999;
    }
    #btnInstall[hidden] { display: none; }
  </style>
</head>
<body class="bg-light">
  
     <!--Navbar-->
    <nav class="navbar navbar-expand-lg fixed-top" style="background-color: #FFEDED; padding-top: 15px; padding-bottom: 15px;">
    <div class="container-fluid">
    <a class="navbar-brand" href="#">Home Essence</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
    </button>
      <div class="collapse navbar-collapse" id="navbarNav">
       <ul class="navbar-nav ms-auto">
       <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
       <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
       <li class="nav-item dropdown d-flex align-items-center">
        <a class="nav-link" href="login.html">
        <i class="bi bi-person-fill"></i>
        <span id="userName">Login</span>
        </a>
        <!--Aqui use una flecha personalizada -->
          <span id="userDropdown" class="custom-dropdown-arrow" data-bs-toggle="dropdown">⯆</span>
          <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" id="logoutBtn" href="#">Cerrar sesión</a></li>
          </ul>
      </li>
      </ul>
        </div>
    </div>
</nav>

  <main class="container mt-4" style="padding: 80px;">
    <div id="alertConfig" class="alert alert-warning d-none">
      <strong>Configura Firebase:</strong> Abre <code>index.html</code> y pega tu <em>firebaseConfig</em>.
    </div>

    <div class="text-center mb-4">
      <h1 class="display-4 text-primary mb-3">Productos</h1>
      <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#productoModal">
        Registrar Nuevo Producto
      </button>
      </div>
    <!--Contenedor para mostrar los productos-->
    <div id="productsContainer" class="row mt-4"></div>
  </main>

  <!-- Modal para crear/editar producto -->
  <div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productoModalLabel">Registro de Nuevo Producto</h5>
          <button type="button" class="btn-close btn-close-secondary" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="productoForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="claveProducto" class="form-label">Clave *</label>
                <input type="text" class="form-control" id="claveProducto" placeholder="Ej: PR001" required>
              </div>

              <div class="col-md-6">
                <label for="nombreProducto" class="form-label">Nombre del Producto *</label>
                <input type="text" class="form-control" id="nombreProducto" placeholder="Ej: Lavadora" required>
              </div>

              <div class="col-md-6">
                <label for="precio" class="form-label">Precio *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="precio" placeholder="0.00" step="0.01" required>
                </div>
              </div>

              <div class="col-md-6">
                <label for="stock" class="form-label">Stock *</label>
                <input type="number" class="form-control" id="stock" placeholder="Cantidad disponible" required>
              </div>

              <div class="col-md-6">
                <label for="categoria" class="form-label">Categoría *</label>
                <select id="categoria" class="form-select" required>
                  <option value="">Selecciona una categoria</option>
                  <option value="Sala">Sala</option>
                  <option value="Cocina">Cocina</option>
                  <option value="Recamara">Recámara</option>
                  <option value="Comedor">Comedor</option>
                  <option value="Baño">Baño</option>
                  <option value="Decoración">Decoración</option>
                </select>
              </div>

              <div class="col-12">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea class="form-control" id="descripcion" rows="3" placeholder="Describe brevemente el producto..."></textarea>
              </div>

              <div class="col-12">
                <label for="imagenes" class="form-label">Imágenes del Producto (puedes subir una o varias)</label>
                <input type="file" id="imagenes" class="form-control" accept="image/*" multiple>
                <div id="previewImagenes" class="thumbs-grid mt-2"></div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="productoForm" class="btn btn-primary" id="submitBtn">
           <span class="spinner-border spinner-border-sm d-none" id="submitSpinner"></span>Guardar Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBAfCWNZ0UuXdYtToCEeEt_eDH5QY_Z83Y",
      authDomain: "mi-primer-proyecto-b175f.firebaseapp.com",
      projectId: "mi-primer-proyecto-b175f",
      storageBucket: "mi-primer-proyecto-b175f.appspot.com",
      messagingSenderId: "569020481723",
      appId: "1:569020481723:web:5ef634bfb6b9ee6aefe99e",
      measurementId: "G-9P6ZL4D5RW"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      query,
      orderBy,
      deleteDoc,
      doc,
      enableIndexedDbPersistence,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Inicializar Firebase/Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db)
    .then(()=>{
      console.log("Persistencia offline habilitada");
      showAlert("Modo offline disponible", "success");
    })
    .catch((err)=>{
      if (err.code == 'failed-precondition') {
        console.log("Múltiples pestañas abiertas");
      } else if (err.code == 'unimplemented'){
        console.log("Navegador no soporta persistencia")
      }
    });

    //deteccion de conexion
    function updateOnlineStatus() {
      const status =  navigator.onLine ? 'online' : 'offline';

      if (!navigator.onLine) {
        showAlert("Modo offline activado - Trabajando localmente", "warning");
      } else{
        showAlert("Conectado - Sincronizando con servidor", "success");
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
   
    // Cloudinary (frontend) — coloca tus datos de cuenta
    const cloudName = "dcbdtbkqu"; 
    const uploadPreset = "pwa_unsigned";

    
    const modal = new bootstrap.Modal(document.getElementById('productoModal'));
    const form = document.getElementById('productoForm');
    const container = document.getElementById('productsContainer');
    const imagenesInput = document.getElementById('imagenes');
    const previewDiv = document.getElementById('previewImagenes')

    // Formatea moneda MXN con manejo de valores no numéricos
    function currencyMXN(n) {
      const v = Number(n);
      if (!Number.isFinite(v)) return '0.00';
      return v.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    //preview de las imágenes
    imagenesInput.addEventListener('change', function(e) {
      previewDiv.innerHTML = '';
      const files = Array.from(e.target.files);

      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = function(e){
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'thumb w-100';
          img.style.objectFit = 'cover';
          previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Render de tarjetas
    function renderProducts(productos) {
      container.innerHTML = '';

      if (productos.length === 0){
        container.innerHTML = `
        <div class="col-12 text-center py-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h4 class="text-muted mt-3">No hay productos</h4>
          <p class="text-muted">Agrega tu primer producto haciendo clic en "Nuevo Producto"</p>
        </div>
        `;
        return;
      }

      productos.forEach((producto) => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';

        const imagenesHTML = Array.isArray(producto.imagenes) && producto.imagenes.length>0
        ? producto.imagenes.map(url => `<img src="${url}" class="thumb" alt="${producto.nombre}">`).join('')
        : `<img src="${producto.imagenUrl || 'https://via.placeholder.com/100x100?text=Sin+Imagen'}" class="thumb" alt="${producto.nombre}">`;

        col.innerHTML = `
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="thumbs-grid mb-3">
                ${imagenesHTML}
              </div>
              <h5 class="card-title">${producto.nombre}</h5>
              <p class="card-text">${producto.descripcion}</p>
              <p class="card-text">
                <strong>Precio:</strong>$${currencyMXN(producto.precio)}<br>
                <strong>Categoria:</strong> ${producto.categoria}<br>
                <strong>Stock:</strong>
                <span class="badge ${producto.stock > 0 ? 'bg-success' : 'bg-danger'}">${producto.stock}</span>
              </p>
            </div>
            <div class="card-footer">
              <button class="btn btn-danger w-100" data-action="delete" data-id="${producto.id}">
                <i class="bi bi-trash3"></i> Eliminar
              </button>
            </div>
          </div>
        `;

        container.appendChild(col);
      });

     
     container.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        if (id && confirm('¿Eliminar este producto?')) {
          await deleteDoc(doc(db,'productos', id));
        }
      });
     });
    }

    
    const productosRef = collection(db, 'productos');
    const q = query(productosRef, orderBy('createdAt', 'desc'));

    onSnapshot(q, (snap) => {
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderProducts(arr);
    }, (error) => {
      console.error('Error en snapshot:', error);
    });

    // Subir imágenes a Cloudinary (retorna arreglo de URLs)
    async function uploadImagesToCloudinary(files) {
      const urls = [];

      for (const file of files) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", uploadPreset);
          formData.append("folder", "productos");
          
         try{
          const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          if (data.secure_url) {
            urls.push(data.secure_url);
          } 
        }catch (err) {
          console.error('Error subiendo a imagen', err);
        }
      }
       return urls;
    }
     
    

    // Manejo del formulario
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('submitSpinner');

      submitBtn.disabled = true;
      spinner.classList.remove('d-none')

      const clave = document.getElementById('claveProducto').value.trim();
      const nombre = document.getElementById('nombreProducto').value.trim();
      const precio = parseFloat(document.getElementById('precio').value) || 0;
      const stock = parseInt(document.getElementById('stock').value) || 0;
      const categoria = document.getElementById('categoria').value;
      const color = document.getElementById('color').value;
      const descripcion = document.getElementById('descripcion').value.trim();
      const imgsInput = document.getElementById('imagenes');

      try {
        let imagenesUrls = [];

        if (imagenesInput.files.length > 0) {
          imagenesUrls = await uploadImagesToCloudinary(Array.from(imagenesInput.files));
        }
        // Crear documento base con imagenes vacías
        await addDoc(productosRef, {
          clave,
          nombre,
          precio,
          categoria,
          stock,
          descripcion,
          imagenes: imagenesUrls,
          imagenUrl:  imagenesUrls[0] || '',
          createdAt: serverTimestamp()
        });

        showAlert('Producto guardado correctamente!', 'success');


        //Reset y cerrar modal
        e.target.reset();
        previewDiv.innerHTML = '';
        modal.hide();

      } catch (err) {
        console.error('Error guardando producto:', err);
        showAlert('Ocurrió un error al guardar el producto', 'danger');
      } finally{
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade shadow position-fixed top-0 end-0 m-3`;
      alertDiv.style.zIndex = `1060`;
      alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

  </script>

</body>
</html>